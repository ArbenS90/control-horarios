<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro - Panadería</title>
    <link rel="stylesheet" href="/css/styles.css">
    <!-- Librería para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXELQXYUnBbbMKlRb1zjidKfSEjdpJNwg",
            authDomain: "control-horarios-88c8e.firebaseapp.com",
            projectId: "control-horarios-88c8e",
            storageBucket: "control-horarios-88c8e.firebasestorage.app",
            messagingSenderId: "487898475731",
            appId: "1:487898475731:web:1e4b3b0d0f4004d95ef826",
            measurementId: "G-E1TPXYMX74"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Hacer las variables globales
        window.db = db;
        window.auth = auth;
        window.Timestamp = Timestamp;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>
    <script src="firebase-config.js"></script>
    <script src="database.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🥖 Sistema de Registro - Panadería</h1>
            <p id="currentDateTime"></p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="tab-content active">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesión</h2>
                <div id="loginAlert"></div>
                <div class="form-group">
                    <label for="loginDocument">Documento de Identidad:</label>
                    <input type="text" id="loginDocument" placeholder="Ingrese su documento">
                </div>
                <button onclick="login()" style="width: 100%;">Ingresar</button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="showAdminLogin()" style="background: #6c757d;">Administración</button>
                </div>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="adminLoginScreen" class="tab-content">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Acceso Administrativo</h2>
                <div id="adminLoginAlert"></div>
                <div class="form-group">
                    <label for="adminDocument">Documento de Identidad:</label>
                    <input type="text" id="adminDocument" placeholder="Documento de administrador">
                </div>
                <button onclick="adminLogin()" style="width: 100%;">Ingresar como Admin</button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="showUserLogin()" style="background: #6c757d;">Volver a Usuario</button>
                </div>
            </div>
        </div>

        <!-- User Dashboard -->
        <div id="userDashboard" class="tab-content">
            <div class="user-info">
                <h3>Bienvenido/a, <span id="userName"></span></h3>
                <p><strong>Documento:</strong> <span id="userDocument"></span></p>
                <p><strong>Estado:</strong> <span id="userStatus"></span></p>
                <button onclick="logout()" class="logout-btn">Cerrar Sesión</button>
            </div>

            <div class="current-session" id="currentSession" style="display: none;">
                <h4>Sesión Actual</h4>
                <p><strong>Inicio:</strong> <span id="sessionStart"></span></p>
                <p><strong>Tiempo trabajado:</strong> <span id="workedTime">00:00:00</span></p>
                <p><strong>Tiempo en break:</strong> <span id="breakTime">00:00:00</span></p>
            </div>

            <div class="time-controls">
                <div class="control-card">
                    <h4>Control de Turno</h4>
                    <button id="startShiftBtn" onclick="startShift()" style="width: 100%; margin-bottom: 10px;">
                        Comenzar Turno
                    </button>
                    <button id="endShiftBtn" onclick="endShift()" style="width: 100%; background: #dc3545;" disabled>
                        Terminar Turno
                    </button>
                </div>

                <div class="control-card">
                    <h4>Descansos</h4>
                    <button id="startBreakBtn" onclick="startBreak()" style="width: 100%; margin-bottom: 10px; background: #ffc107;" disabled>
                        Iniciar Break
                    </button>
                    <button id="endBreakBtn" onclick="endBreak()" style="width: 100%; background: #28a745;" disabled>
                        Terminar Break
                    </button>
                </div>

                <div class="control-card">
                    <h4>Evidencias</h4>
                    <input type="file" id="evidenceInput" accept="image/*" multiple style="margin-bottom: 10px;">
                    <textarea id="evidenceNote" placeholder="Nota sobre la evidencia (opcional)" rows="3"></textarea>
                    <button onclick="uploadEvidence()" style="width: 100%; background: #17a2b8;">
                        Subir Evidencia
                    </button>
                </div>
            </div>

            <div id="evidencePreview" class="evidence-preview"></div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="tab-content">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showAdminTab('users')">Usuarios</button>
                <button class="nav-tab" onclick="showAdminTab('reports')">Reportes</button>
                <button class="nav-tab" onclick="showAdminTab('evidence')">Evidencias</button>
            </div>

            <div class="user-info">
                <h3>Panel Administrativo - <span id="adminName"></span></h3>
                <button onclick="logout()" class="logout-btn">Cerrar Sesión</button>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="admin-tab-content">
                <div class="admin-form" style="max-width: 600px;">
                    <h3>Registrar Nuevo Usuario</h3>
                    <div id="userAlert"></div>
                    <div class="form-group">
                        <label for="newUserName">Nombre Completo:</label>
                        <input type="text" id="newUserName" placeholder="Nombre completo del empleado">
                    </div>
                    <div class="form-group">
                        <label for="newUserDocument">Documento de Identidad:</label>
                        <input type="text" id="newUserDocument" placeholder="Número de documento">
                    </div>
                    <div class="form-group">
                        <label for="newUserType">Tipo de Usuario:</label>
                        <select id="newUserType">
                            <option value="empleado">Empleado</option>
                            <option value="admin">Administrador</option>
                            <option value="super_admin">Super Administrador</option>
                        </select>
                    </div>
                    <button onclick="createUser()" style="width: 100%;">Crear Usuario</button>
                </div>

                <div class="user-list" id="userList"></div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="admin-tab-content hidden">
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="filterUser">Filtrar por Usuario:</label>
                        <select id="filterUser">
                            <option value="">Todos los usuarios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterDate">Filtrar por Fecha:</label>
                        <input type="date" id="filterDate">
                    </div>
                    <div class="form-group">
                        <label for="filterDateRange">Rango de Fechas:</label>
                        <input type="date" id="filterStartDate" placeholder="Fecha inicio">
                        <input type="date" id="filterEndDate" placeholder="Fecha fin" style="margin-top: 10px;">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <button onclick="filterRecords()">Filtrar</button>
                        <button onclick="exportToExcel()" style="background: #28a745;">Exportar Excel</button>
                    </div>
                </div>

                <table class="records-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Documento</th>
                            <th>Fecha</th>
                            <th>Inicio Turno</th>
                            <th>Fin Turno</th>
                            <th>Horas Trabajadas</th>
                            <th>Tiempo Break</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                </table>
            </div>

            <!-- Evidence Tab -->
            <div id="evidenceTab" class="admin-tab-content hidden">
                <h3>Evidencias Subidas</h3>
                <div id="evidenceList"></div>
            </div>
        </div>
    </div>

    <script src="/js/script.js"></script>
</body>
</html>